<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>OpenAI Crawler Visits Dashboard</title>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .chart {
                margin-bottom: 60px;
            }
        </style>
    </head>
    <body>
        <h1>OpenAI Crawlers Overview</h1>

        <div id="fig1" class="chart"></div>
        <div id="fig2" class="chart"></div>
        <div id="fig3" class="chart"></div>

        <script>
            (async function () {
                const API_URL =
                    "https://www.particleformen.com/wp-json/get-data/v1/openai-crawlers/overview?exclude_last=1&limit=10";
                const DOMAIN = "https://www.particleformen.com/";

                console.log("[INFO] Fetching data from API...");
                const r = await fetch(API_URL, {
                    headers: {
                        "User-Agent": navigator.userAgent,
                        Accept: "application/json",
                    },
                });
                if (!r.ok) {
                    console.error("API request failed:", r.status, r.statusText);
                    return;
                }
                const payload = await r.json();
                console.log("[INFO] Payload received:", payload);

                const days = payload.meta.days.map((d) => new Date(d));

                // === Fig 1: Top 10 daily ===
                const top10 = payload.top10;
                const pages = top10.pages;
                const totals = top10.totals;
                const grand_total_top10 = top10.grand_total;

                const fig1_traces = pages.map((p) => {
                    const y = days.map((d) => top10.daily[p][d.toISOString().split("T")[0]] || 0);
                    return {
                        x: days,
                        y: y,
                        mode: "lines",
                        name: p.replace(DOMAIN, "") + ` (${totals[p]})`,
                        hovertemplate: "Date: %{x|%Y-%m-%d}<br>Visits: %{y}<extra>%{fullData.name}</extra>",
                    };
                });

                Plotly.newPlot(
                    "fig1",
                    fig1_traces,
                    {
                        title: `Open AI Crawlers Daily Visits â€” Top 10 Pages (${grand_total_top10} total visits)`,
                        xaxis: { title: "" },
                        yaxis: { title: "Visits" },
                        hovermode: "closest",
                        legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                        margin: { l: 60, r: 20, t: 80, b: 100 },
                    },
                    { responsive: true }
                );

                // === Fig 2: Total daily (all pages) ===
                const total_daily = days.map((d) => payload.total_daily.series[d.toISOString().split("T")[0]] || 0);
                const grand_total_all = total_daily.reduce((a, b) => a + b, 0);

                Plotly.newPlot(
                    "fig2",
                    [
                        {
                            x: days,
                            y: total_daily,
                            mode: "lines+markers",
                            name: "Total Visits",
                            hovertemplate: "Date: %{x|%Y-%m-%d}<br>Total Visits: %{y}<extra></extra>",
                        },
                    ],
                    {
                        title: `Open AI Crawlers Daily Total Visits (${grand_total_all} total visits)`,
                        xaxis: { title: "" },
                        yaxis: { title: "Total Visits" },
                        hovermode: "closest",
                        legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                        margin: { l: 60, r: 20, t: 80, b: 100 },
                    },
                    { responsive: true }
                );

                // === Fig 3: Daily by crawler type ===
                const crawl = payload.crawler_daily;
                const types = crawl.types;
                const type_totals = crawl.totals;

                const fig3_traces = types.map((ct) => {
                    const y = days.map((d) => crawl.daily[ct][d.toISOString().split("T")[0]] || 0);
                    return {
                        x: days,
                        y: y,
                        mode: "lines",
                        name: `${ct} (${type_totals[ct]})`,
                        hovertemplate: "Date: %{x|%Y-%m-%d}<br>Visits: %{y}<extra>%{fullData.name}</extra>",
                    };
                });

                const annotations = [
                    "<b>OAI-SearchBot</b>: For search results. Not used for model training.",
                    "<b>ChatGPT-User</b>: User-triggered fetches from ChatGPT/Custom GPTs.",
                    "<b>GPTBot</b>: Training crawler; disallow via robots.txt to opt out.",
                ].map((text, i) => ({
                    text: text,
                    xref: "paper",
                    yref: "paper",
                    x: 0,
                    y: -0.35 - i * 0.06,
                    showarrow: false,
                    align: "left",
                    font: { size: 11, color: "gray" },
                }));

                Plotly.newPlot(
                    "fig3",
                    fig3_traces,
                    {
                        title: "Open AI Crawlers Daily Visits per Crawler Type",
                        xaxis: { title: "" },
                        yaxis: { title: "Visits" },
                        hovermode: "closest",
                        legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                        margin: { l: 60, r: 20, t: 100, b: 180 },
                        annotations: annotations,
                    },
                    { responsive: true }
                );
            })();
        </script>
    </body>
</html>
