<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>OpenAI Crawler Visits Dashboard</title>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .chart {
                margin-bottom: 60px;
            }
        </style>
    </head>
    <body>
        <h1>OpenAI Crawlers Overview</h1>

        <div id="fig1" class="chart"></div>
        <div id="fig1b" class="chart"></div>
        <div id="fig1c" class="chart"></div>
        <div id="fig2" class="chart"></div>
        <div id="fig3" class="chart"></div>

        <script>
            (async function () {
                const API_URL =
                    "https://www.particleformen.com/wp-json/get-data/v1/openai-crawlers/overview?exclude_last=1&limit=10&cache=3";
                const DOMAIN = "https://www.particleformen.com/";

                const r = await fetch(API_URL, {
                    headers: { "User-Agent": navigator.userAgent, Accept: "application/json" },
                });
                if (!r.ok) return console.error("API request failed:", r.status, r.statusText);

                const payload = await r.json();
                const days = payload.meta.days.map((d) => new Date(d));

                // === Fig 1: Top 10 daily — ALL crawlers (unchanged except template literal fixes) ===
                const top10 = payload.top10;
                const pages = top10.pages;
                const totals = top10.totals;
                const grand_total_top10 = top10.grand_total;

                const fig1_traces = pages.map((p) => {
                    const y = days.map((d) => top10.daily[p][d.toISOString().split("T")[0]] || 0);
                    return {
                        x: days,
                        y,
                        mode: "lines",
                        name: `${p.replace(DOMAIN, "")} (${totals[p]})`,
                        hovertemplate: "Date: %{x|%Y-%m-%d}<br>Visits: %{y}<extra>%{fullData.name}</extra>",
                    };
                });

                Plotly.newPlot(
                    "fig1",
                    fig1_traces,
                    {
                        title: `Open AI Crawlers Daily Visits — Top 10 Pages (${grand_total_top10} total visits)`,
                        xaxis: { title: "" },
                        yaxis: { title: "Visits" },
                        hovermode: "closest",
                        legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                        margin: { l: 60, r: 20, t: 80, b: 100 },
                    },
                    { responsive: true }
                );

                // === Fig 1B: Top 10 daily — ChatGPT-User only (NEW) ===
                // Payload key should be "ChatGPT-User". Fallbacks in case DB uses different casing.
                const typeBlock =
                    (payload.top10_by_type &&
                        (payload.top10_by_type["ChatGPT-User"] ||
                            payload.top10_by_type["chatGPT-USER"] ||
                            payload.top10_by_type["CHATGPT-USER"] ||
                            payload.top10_by_type["ChatGPT-USER"])) ||
                    null;

                if (typeBlock) {
                    const tPages = typeBlock.pages;
                    const tTotals = typeBlock.totals;
                    const tGrand = typeBlock.grand_total;

                    const fig1b_traces = tPages.map((p) => {
                        const y = days.map((d) => typeBlock.daily[p][d.toISOString().split("T")[0]] || 0);
                        return {
                            x: days,
                            y,
                            mode: "lines",
                            name: `${p.replace(DOMAIN, "")} (${tTotals[p]})`,
                            hovertemplate: "Date: %{x|%Y-%m-%d}<br>Visits: %{y}<extra>%{fullData.name}</extra>",
                        };
                    });

                    Plotly.newPlot(
                        "fig1b",
                        fig1b_traces,
                        {
                            title: `ChatGPT-User Daily Visits — Top 10 Pages (${tGrand} total visits)`,
                            xaxis: { title: "" },
                            yaxis: { title: "Visits" },
                            hovermode: "closest",
                            legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                            margin: { l: 60, r: 20, t: 80, b: 100 },
                        },
                        { responsive: true }
                    );
                } else {
                    console.warn("[INFO] No top10_by_type block for ChatGPT-User in payload.");
                }

                // === Fig 1C: Top 10 daily — ChatGPT-Referral (real users) ===
                const referralBlock =
                    (payload.top10_by_type &&
                        (payload.top10_by_type["ChatGPT-Referral"] ||
                            payload.top10_by_type["chatgpt-referral"] ||
                            payload.top10_by_type["CHATGPT-REFERRAL"])) ||
                    null;

                if (referralBlock) {
                    const rPages = referralBlock.pages || [];
                    const rTotals = referralBlock.totals || {};
                    const rGrand = referralBlock.grand_total || 0;

                    const fig1c_traces = rPages.map((p) => {
                        const y = days.map((d) => referralBlock.daily[p][d.toISOString().split("T")[0]] || 0);
                        return {
                            x: days,
                            y,
                            mode: "lines",
                            name: `${p.replace(DOMAIN, "")} (${rTotals[p]})`,
                            hovertemplate: "Date: %{x|%Y-%m-%d}<br>Visits: %{y}<extra>%{fullData.name}</extra>",
                        };
                    });

                    Plotly.newPlot(
                        "fig1c",
                        fig1c_traces,
                        {
                            title: `ChatGPT-Referral Daily Visits — Top 10 Pages (${rGrand} total visits)`,
                            xaxis: { title: "" },
                            yaxis: { title: "Visits" },
                            hovermode: "closest",
                            legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                            margin: { l: 60, r: 20, t: 80, b: 100 },
                        },
                        { responsive: true }
                    );
                } else {
                    console.warn("[INFO] No top10_by_type block for ChatGPT-Referral in payload.");
                }

                // === Fig 2: Total daily (all pages) ===
                const total_daily = days.map((d) => payload.total_daily.series[d.toISOString().split("T")[0]] || 0);
                const grand_total_all = total_daily.reduce((a, b) => a + b, 0);

                Plotly.newPlot(
                    "fig2",
                    [
                        {
                            x: days,
                            y: total_daily,
                            mode: "lines+markers",
                            name: "Total Visits",
                            hovertemplate: "Date: %{x|%Y-%m-%d}<br>Total Visits: %{y}<extra></extra>",
                        },
                    ],
                    {
                        title: `Open AI Crawlers Daily Total Visits (${grand_total_all} total visits)`,
                        xaxis: { title: "" },
                        yaxis: { title: "Total Visits" },
                        hovermode: "closest",
                        legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                        margin: { l: 60, r: 20, t: 80, b: 100 },
                    },
                    { responsive: true }
                );

                // === Fig 3: Daily by crawler type (fix name template) ===
                const crawl = payload.crawler_daily;
                const types = crawl.types;
                const type_totals = crawl.totals;

                const fig3_traces = types.map((ct) => {
                    const y = days.map((d) => crawl.daily[ct][d.toISOString().split("T")[0]] || 0);
                    return {
                        x: days,
                        y,
                        mode: "lines",
                        name: `${ct} (${type_totals[ct]})`,
                        hovertemplate: "Date: %{x|%Y-%m-%d}<br>Visits: %{y}<extra>%{fullData.name}</extra>",
                    };
                });

                const annotations = [
                    "<b>OAI-SearchBot</b>: For search results. Not used for model training.",
                    "<b>ChatGPT-User</b>: User-triggered fetches from ChatGPT/Custom GPTs.",
                    "<b>GPTBot</b>: Training crawler; disallow via robots.txt to opt out.",
                ].map((text, i) => ({
                    text,
                    xref: "paper",
                    yref: "paper",
                    x: 0,
                    y: -0.35 - i * 0.06,
                    showarrow: false,
                    align: "left",
                    font: { size: 11, color: "gray" },
                }));

                Plotly.newPlot(
                    "fig3",
                    fig3_traces,
                    {
                        title: "Open AI Crawlers Daily Visits per Crawler Type",
                        xaxis: { title: "" },
                        yaxis: { title: "Visits" },
                        hovermode: "closest",
                        legend: { orientation: "h", yanchor: "top", y: -0.2, xanchor: "center", x: 0.5 },
                        margin: { l: 60, r: 20, t: 100, b: 180 },
                        annotations,
                    },
                    { responsive: true }
                );
            })();
        </script>
    </body>
</html>
